---

# 乐器循环录音 App - 代码向 PRD / 交互说明

> 目标：这是一份为 AI 编码工具准备的规格说明文档。  
> 平台：iOS App（Swift + SwiftUI + AVAudioEngine / AudioKit）。  
> 期望：AI 工具可以直接据此搭建基础工程、数据结构、主要界面和核心逻辑骨架。

---

## 1. 工程基础信息

- 平台：iOS
- 最低版本：iOS 17.0+
- 语言：Swift 5.9+
- UI 框架：SwiftUI（优先），如有必要可在后续引入 UIKit
- 音频框架：优先 AVAudioEngine；如实现复杂可根据需要引入 AudioKit
- 架构建议：MVVM 或 MV Pattern 即可（不需要复杂架构）

---

## 2. 功能范围（MVP）

本 PRD 只针对 **MVP 版本**，要求实现以下能力：

1. 主创作页面（首页）
2. 多轨循环录音（默认 4 轨）
3. 简单节拍器与 BPM 设置
4. 每轨音量控制 + 静音
5. 作品（项目）自动保存 / 加载
6. 导出混音为音频文件（MP3 或 M4A）
7. 简单撤销（最近几步操作）

**明确不在 MVP 范围内：**

- 高级音效（EQ、压缩、失真）
- 社区、云同步
- 复杂编辑（波形精确裁剪）
- iPad 专用布局（初期使用简单自适应即可）

---

## 3. 核心概念与数据模型

### 3.1 核心概念

- Project（作品 / 工程）
  - 包含多个 Track（音轨）
  - 有全局属性：BPM、循环小节数、创建时间、修改时间等
- Track（轨道）
  - 对应一条 Loop 音频（WAV 文件）
  - 有音量、静音、声像、颜色等属性
- Loop
  - 一段长度固定的音频片段，循环播放

### 3.2 数据模型（Swift 结构体建议）

#### 3.2.1 TrackModel

```swift
enum TrackSourceType: String, Codable {
    case mic      // 麦克风录音
    case drum     // 虚拟鼓组
    case keys     // 虚拟键盘（后续）
    case sample   // 采样（后续）
}

struct TrackModel: Identifiable, Codable {
    let id: UUID
    var name: String
    var filePath: String?      // 相对路径，例如 "track_1.wav"，空表示还没录
    var volume: Float          // 0.0 ~ 1.0
    var pan: Float             // -1.0 (左) ~ 1.0 (右)，MVP 可暂时固定为 0
    var muted: Bool
    var solo: Bool             // MVP 可不实现 solo 逻辑，后续扩展
    var colorHex: String       // 用字符串存颜色，例如 "#FFAA00"
    var sourceType: TrackSourceType
}
```

#### 3.2.2 ProjectModel

```swift
struct ProjectModel: Identifiable, Codable {
    let id: UUID
    var name: String
    var bpm: Int               // 例如 60 ~ 200
    var loopBars: Int          // 循环小节数，例如 2 / 4 / 8
    var tracks: [TrackModel]
    var createdAt: Date
    var modifiedAt: Date
}
```

#### 3.2.3 全局设置（可选）

```swift
struct AppSettings: Codable {
    var lastOpenedProjectId: UUID?
    var defaultBPM: Int
    var defaultLoopBars: Int
}
```

---

## 4. 文件与存储结构

### 4.1 本地文件目录约定

使用 `FileManager`，在 App 的 Documents 目录下：

```text
/Documents/Projects/
  ├── {projectId}/
  │   ├── project.json          // 对应 ProjectModel
  │   ├── track_{uuid1}.wav     // 每条轨对应一个 wav 文件
  │   ├── track_{uuid2}.wav
  │   └── ...
  └── ...
```

- `projectId` 使用 `UUID().uuidString`
- `project.json` 使用 `JSONEncoder/JSONDecoder` 序列化 `ProjectModel`

### 4.2 数据加载策略

- App 启动时：
  - 尝试读取 `AppSettings`（可存入 `UserDefaults`）
  - 如果有 `lastOpenedProjectId`，加载对应 Project
  - 如果没有，创建一个新的默认 Project（名称：“未命名作品”+日期）

- 每次操作（录音完成、音量改变、轨道新增删除）后：
  - 更新 ProjectModel 并异步保存 `project.json`

---

## 5. 音频引擎需求（逻辑层）

### 5.1 基础要求

- 采样率：48kHz
- 缓冲大小：256 samples（尽量低延迟）
- 内部录音格式：WAV（16-bit 或 24-bit）
- 支持：
  - 从麦克风录音到指定 `.wav` 文件
  - 同时播放多条 `.wav` 文件循环（多轨混音）
  - 保证循环边界无明显断点
  - 多轨播放尽量保持样本级对齐（误差 < 10ms）

### 5.2 音频引擎接口设计建议（Swift 类）

定义一个 `AudioEngineManager`，负责音频相关功能。

```swift
class AudioEngineManager {
    static let shared = AudioEngineManager()
    
    // 配置
    var bpm: Int
    var loopBars: Int
    var sampleRate: Double
    
    // 基本控制
    func startEngine() throws
    func stopEngine()
    
    // 播放控制
    func startPlayback(project: ProjectModel)
    func stopPlayback()
    func pausePlayback()
    
    // 录音控制
    func startRecording(to fileURL: URL, forTrackId trackId: UUID, completion: @escaping (Bool) -> Void)
    func stopRecording(forTrackId trackId: UUID)
    
    // 更新轨道参数
    func updateTrackVolume(trackId: UUID, volume: Float)
    func updateTrackMute(trackId: UUID, muted: Bool)
    
    // 时间 / 循环相关
    // 可选：提供一个回调，给 UI 更新循环进度
    var onLoopProgress: ((UUID, Double) -> Void)?   // trackId, progress(0~1)
}
```

> 要求：  
> - 录音与播放可以同时进行（边放边录）。  
> - 播放与录音使用同一个 AVAudioEngine 实例。  
> - 对于循环播放，读取同一个 `.wav` 文件，当播放到结尾时无缝回绕。

---

## 6. UI / 交互结构（SwiftUI 为主）

### 6.1 页面概览

1. `MainView`（主创作页）  
   - 默认打开的页面  
   - 显示：当前 Project 的轨道卡片、全局控制（播放、停止、撤销等）

2. `ProjectListView`（项目列表）  
   - 显示已有 Project 列表  
   - 允许创建新 Project、重命名、删除

3. `TrackDetailView`（轨道详情，使用 Sheet / Bottom Sheet）  
   - 长按轨道卡片弹出  
   - 调整轨道名称、音量、静音、声像等

4. `ExportView`（导出选择弹窗）  
   - 选择导出整首 / 某个轨道  
   - 选择格式：MP3 / M4A / WAV  
   - 质量：标准 / 高质量

5. `SettingsView`（简单设置）  
   - 默认 BPM、默认循环小节数等

---

### 6.2 主创作页面：布局与交互

#### 6.2.1 MainView 布局（逻辑描述）

区域划分：

1. 顶部栏
   - 左侧：[菜单按钮] 打开 ProjectList / 设置
   - 中间：当前作品名称（可点击修改 / 打开导出菜单）
   - 右侧：[设置按钮]

2. 播放控制区
   - 按钮：播放/暂停（⏯）、停止（⏹）、撤销（⟲）
   - 文本：BPM 显示（如：BPM: 120）
   - 控件：节拍器开关（Toggle）
   - （可选）速度滑块：暂略或后续实现

3. 轨道区域（4 轨，2x2 卡片式）
   - 每个 `TrackCardView` 包含：
     - 轨道名称（如 “Track 1”）
     - 状态视图（空轨提示 / 录音中 / 循环播放中）
     - 简单波形占位（可先用颜色条代替）
     - 音量滑块（0~1）
     - 静音按钮（图标 🔇）

4. 底部录音源选择
   - 水平按钮：
     - [🎤 麦克风]（默认选中）
     - [🥁 鼓组]（后续调用虚拟鼓界面）
     - [🎹 键盘]（MVP 可暂不实现或保留空界面）

#### 6.2.2 MainView 行为规则

- 轨道卡片点击（Tap）行为：
  - 如果该轨道还未录音（`filePath == nil`）：
    - 点击后开始录音（通过 AudioEngineManager）
    - 使用当前录音源（mic 或 其他）
    - 再次点击同一轨道 → 停止录音 → 写入 wav 文件 → 更新 ProjectModel → 开始循环播放该轨道
  - 如果该轨道已有音频：
    - 若当前全局正在播放：点击切换该轨道 **静音 / 非静音**
    - 若当前没有播放：点击可视为“从当前位置播放并听该轨道”（简化起见，也可以让点击仅仅切换静音）

- 轨道卡片长按（LongPress）行为：
  - 打开 `TrackDetailView`：底部弹出 Sheet
  - 显示该轨的详细控制：
    - 名称编辑
    - 音量滑块（更精细）
    - 静音、独奏开关
    - 删除 / 重录按钮

- 顶部“作品名称”点击行为：
  - 打开 `ProjectMenuSheet`：
    - 重命名
    - 导出作品（打开 ExportView）
    - 复制作品
    - 删除作品

- 播放/停止行为：
  - 播放按钮：
    - 如果当前没有在播放，则：
      - 调用 `AudioEngineManager.startPlayback(project:)`
  - 停止按钮：
    - 停止所有轨道播放

- 撤销行为（MVP 简化）：
  - 记录最近若干操作（例如：录音完成、删除轨道、调整音量）
  - 点击撤销后：
    - 恢复到上一版本的 `ProjectModel`（可用简单的栈保存快照）

---

## 7. 导出逻辑

### 7.1 基本要求

- 支持导出为 M4A（优先）、MP3（如有现成库可用）或 WAV
- 可以导出：
  - 整体混音（所有未静音轨道的合成）
  - 单轨音频（可选）

### 7.2 简单接口设计

建议在 `AudioEngineManager` 增加：

```swift
extension AudioEngineManager {
    /// 导出混音到指定 URL，完成后回调
    func exportMixdown(project: ProjectModel, to url: URL, completion: @escaping (Bool) -> Void)
}
```

实现方式可采用离线渲染（standard offline rendering）或先混到一个临时 audio buffer 再写入文件。

---

## 8. 权限与生命周期

### 8.1 麦克风权限

- 首次进入 MainView 时：
  - 检查麦克风权限
  - 若未授权，弹出说明 + 系统权限请求
- 未授权时：
  - 禁用录音相关按钮
  - 显示提示文案“需要麦克风权限才能录音”

### 8.2 生命周期

- App 进入后台时：
  - 自动停止录音
  - 可以选择暂停/停止播放（按实际实现简化）

---

## 9. MVP 任务拆分建议

### 任务 1：项目数据层与本地存储

- 实现 `ProjectModel`, `TrackModel`
- 实现 Project 的创建 / 读取 / 保存
- 建立 `ProjectRepository` 类（加载和保存 JSON）

### 任务 2：AudioEngineManager 基础

- 初始化 AVAudioEngine
- 实现：
  - startEngine / stopEngine
  - 从麦克录音到 wav 文件
  - 播放指定 wav 文件（单轨测试）
- 后续再实现多轨循环播放

### 任务 3：主界面 MainView

- 用 SwiftUI 搭建布局（Top Bar + Controls + 4 Track Cards + Bottom Source Selector）
- TrackCardView 绑定到 `TrackModel`
- 点击事件与 `MainViewModel` 对接

### 任务 4：多轨循环播放

- 在 AudioEngineManager 实现多轨循环播放，并与 MainView 连通
- 确保录完一条轨道后，能与其他轨道同步循环

### 任务 5：导出功能

- 实现 `exportMixdown`
- 加一个简单的 ExportView + 系统分享调用

---

